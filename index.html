<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveillance des Navires - Seine</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Banni√®re d'alerte rouge (masqu√©e par d√©faut) -->
    <div id="banniereAlerte" class="banniere-alerte" style="display: none;">
        üö® ALERTE ROUGE : Navire d√©tect√© √† moins de 1km ! üö®
    </div>

    <!-- Panneau d'attention orange (masqu√© par d√©faut) -->
    <div id="panneauAttention" class="panneau-attention" style="display: none;">
        <div style="font-size: 20px; margin-bottom: 15px;">‚ö†Ô∏è VIGILANCE</div>
        <div>Navires en zone de surveillance (2km) :</div>
        <div id="naviresVigilance"></div>
    </div>

    <!-- Compteur de rafra√Æchissement -->
    <div id="compteurRefresh" class="compteur-refresh">
        Prochaine MAJ : 15s
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üö¢ Surveillance des Navires - Seine</h1>
            <p>API EuRIS : surveillance automatique avec alertes de proximit√©</p>
        </div>

        <!-- Contr√¥les -->
        <div class="controls">
            <!-- Configuration de base -->
            <div class="form-group">
                <div>
                    <label for="tokenEuris">Token EuRIS :</label>
                    <input type="text" id="tokenEuris" placeholder="Votre token d'acc√®s EuRIS">
                </div>
                <div>
                    <label for="filtreNavire">Filtre navire :</label>
                    <select id="filtreNavire">
                        <option value="tous">Tous les navires</option>
                        <option value="cargo">Cargo uniquement</option>
                        <option value="passager">Navires √† passagers</option>
                        <option value="peche">Bateaux de p√™che</option>
                    </select>
                </div>
            </div>

            <!-- Coordonn√©es de surveillance -->
            <div class="form-group">
                <div>
                    <label for="latitudeCenter">Latitude centre :</label>
                    <input type="number" id="latitudeCenter" value="49.4944" step="0.0001">
                </div>
                <div>
                    <label for="longitudeCenter">Longitude centre :</label>
                    <input type="number" id="longitudeCenter" value="0.1079" step="0.0001">
                </div>
                <div>
                    <label for="rayonSurveillance">Rayon surveillance (km) :</label>
                    <input type="number" id="rayonSurveillance" value="5" min="1" max="50">
                </div>
            </div>

            <!-- MODIFI√â : Contr√¥le Prise Tapo P110 avec tests avanc√©s -->
            <div class="tapo-controls">
                <h3>üîå Contr√¥le Prise Tapo P110</h3>
                
                <!-- Auto-d√©tection IP -->
                <div class="form-group">
                    <div>
                        <label for="serverIp">IP Serveur Local :</label>
                        <input type="text" id="serverIp" value="auto" placeholder="auto ou 192.168.1.100">
                        <small>Tapez "auto" pour d√©tection automatique</small>
                    </div>
                    <div>
                        <button class="btn btn-scan" onclick="scannerReseauLocal()">üîç Scanner r√©seau</button>
                    </div>
                </div>
                
                <!-- NOUVEAU : Tests rapides -->
                <div class="tapo-buttons">
                    <button class="btn btn-purple" onclick="pingServeur()">üì° Ping</button>
                    <button class="btn btn-blue" onclick="obtenirStatutPrise()">üìä Statut</button>
                    <button class="btn btn-green" onclick="allumerPrise()">üü¢ Allumer</button>
                    <button class="btn btn-red" onclick="eteindrePrise()">üî¥ √âteindre</button>
                </div>

                <!-- NOUVEAU : Tests avanc√©s -->
                <div class="tapo-buttons">
                    <button class="btn btn-orange" onclick="testPrise10sec()">üß™ Test 10s</button>
                    <button class="btn btn-blue" onclick="testPrise1sec()">‚ö° Flash 1s</button>
                    <button class="btn btn-orange" onclick="testClignotement()">üîÑ Clignote 5x</button>
                    <button class="btn btn-purple" onclick="testCompletPrise()">üî¨ Test complet</button>
                </div>
                
                <!-- Statut de la prise -->
                <div id="tapoStatus" class="tapo-status">
                    <span class="status-indicator status-connecting">üîÑ Recherche serveur...</span>
                </div>
                
                <!-- Configuration automatique -->
                <div class="auto-config">
                    <label>
                        <input type="checkbox" id="autoTrigger" checked> 
                        D√©clencher automatiquement (navire < 1km)
                    </label>
                    <label>
                        Dur√©e d'alerte : <input type="number" id="alertDuration" value="10" min="5" max="300"> sec
                    </label>
                    <!-- NOUVEAU : Option sir√®ne -->
                    <label>
                        <input type="checkbox" id="enableSiren" checked> 
                        üîä Sir√®ne 2s
                    </label>
                </div>
            </div>

            <!-- Bouton principal -->
            <button id="btnSurveillance" class="btn" onclick="toggleSurveillance()">
                D√©marrer la surveillance
            </button>
            
            <!-- Statut de connexion -->
            <div id="statusIndicator" class="status-indicator status-connecting">
                üîÑ Pr√™t √† d√©marrer
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="content">
            <!-- Carte -->
            <div class="map-container">
                <div id="map"></div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Statistiques -->
                <div class="stats">
                    <h3>üìä Statistiques</h3>
                    <div class="stat-item">
                        <span class="stat-label">Navires d√©tect√©s</span>
                        <span class="stat-value" id="totalNavires">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üü¢ Zone d'approche (3km)</span>
                        <span class="stat-value" id="naviresApproche">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üü† Zone vigilance (2km)</span>
                        <span class="stat-value" id="naviresVigilanceCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üî¥ Zone alerte (1km)</span>
                        <span class="stat-value" id="naviresAlerte">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Derni√®re MAJ</span>
                        <span class="stat-value" id="derniereMaj">Jamais</span>
                    </div>
                </div>

                <!-- Liste des navires -->
                <div class="navires-list">
                    <h3>üö¢ Navires surveill√©s</h3>
                    <div id="listeNavires" class="loading">
                        Cliquez sur "D√©marrer la surveillance" pour commencer...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NOUVEAU : Audio pour sir√®ne -->
    <audio id="sirenAudio" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuHwwF8aBAx6zfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBQB6zfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBT6HzfTLeFwFJHfH8N2QQAoUXrTp66hVFApGnuDyvmAaBQ==" type="audio/wav">
    </audio>

    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let map;
        let surveillanceActive = false;
        let intervalSurveillance;
        let intervalCompteur;
        let compteurRefresh = 15; // MODIFI√â : 30 -> 15
        let markersNavires = [];
        let cerclesZones = [];
        
        // Variables Tapo
        let serverTapoUrl = null;
        let priseEnCours = false;
        let ipsDetectees = [];

        // ========================================
        // INITIALISATION DE LA CARTE (INCHANG√âE)
        // ========================================
        function initCarte() {
            const lat = parseFloat(document.getElementById('latitudeCenter').value);
            const lon = parseFloat(document.getElementById('longitudeCenter').value);
            
            map = L.map('map').setView([lat, lon], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Marqueur de position de surveillance
            L.marker([lat, lon]).addTo(map)
                .bindPopup('üìç Position de surveillance')
                .openPopup();
            
            dessinerZonesSurveillance();
        }

        // ========================================
        // NOUVELLES FONCTIONS TAPO SEULEMENT
        // ========================================

        /**
         * NOUVEAU : Sir√®ne d'alarme de 2 secondes
         */
        function jouerSireneAlarme() {
            const enableSiren = document.getElementById('enableSiren').checked;
            if (!enableSiren) return;

            try {
                const audio = document.getElementById('sirenAudio');
                audio.currentTime = 0;
                audio.play().catch(e => {
                    console.log('üîä Impossible de jouer la sir√®ne, cr√©ation bip');
                    creerBipSynthetique();
                });
                
                setTimeout(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }, 2000);
                
            } catch (error) {
                creerBipSynthetique();
            }
        }

        function creerBipSynthetique() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 2);
            } catch (e) {
                console.log('üîä Son non disponible');
            }
        }

        /**
         * NOUVEAU : Ping serveur
         */
        async function pingServeur() {
            updateServerUrl();
            if (!serverTapoUrl) {
                afficherStatutPrise('‚ùå IP serveur non configur√©e', 'error');
                return;
            }
            
            try {
                afficherStatutPrise('üì° Test ping...', 'info');
                const response = await fetch(`${serverTapoUrl}/ping`);
                if (response.ok) {
                    const result = await response.json();
                    afficherStatutPrise(`‚úÖ Ping OK - ${result.server}`, 'success');
                } else {
                    throw new Error(`Erreur ${response.status}`);
                }
            } catch (error) {
                afficherStatutPrise(`‚ùå Ping √©chou√©: ${error.message}`, 'error');
            }
        }

        /**
         * NOUVEAU : Statut prise
         */
        async function obtenirStatutPrise() {
            updateServerUrl();
            if (!serverTapoUrl) {
                afficherStatutPrise('‚ùå IP serveur non configur√©e', 'error');
                return;
            }
            
            try {
                afficherStatutPrise('üìä Lecture statut...', 'info');
                const response = await fetch(`${serverTapoUrl}/status`);
                if (response.ok) {
                    const result = await response.json();
                    const statut = result.status === 'on' ? 'üü¢ ALLUM√âE' : 'üî¥ √âTEINTE';
                    afficherStatutPrise(`üìä Prise ${statut}`, 'success');
                } else {
                    throw new Error(`Erreur ${response.status}`);
                }
            } catch (error) {
                afficherStatutPrise(`‚ùå Statut inaccessible`, 'error');
            }
        }

        /**
         * NOUVEAU : Test clignotement
         */
        async function testClignotement() {
            if (priseEnCours) return;
            priseEnCours = true;
            afficherStatutPrise('üîÑ Test clignotement 5x...', 'info');
            
            try {
                for (let i = 1; i <= 5; i++) {
                    await controlerPrise('on');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await controlerPrise('off');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                afficherStatutPrise('‚úÖ Clignotement termin√©', 'success');
            } catch (error) {
                afficherStatutPrise('‚ùå Erreur clignotement', 'error');
            } finally {
                priseEnCours = false;
            }
        }

        /**
         * NOUVEAU : Test 10 secondes
         */
        async function testPrise10sec() {
            if (priseEnCours) return;
            priseEnCours = true;
            await controlerPrise('on', 10);
            setTimeout(() => { priseEnCours = false; }, 11000);
        }

        /**
         * NOUVEAU : Test complet
         */
        async function testCompletPrise() {
            if (priseEnCours) return;
            priseEnCours = true;
            
            try {
                await pingServeur();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await obtenirStatutPrise();
                await new Promise(resolve => setTimeout(resolve, 1000));
                await controlerPrise('on', 3);
                await new Promise(resolve => setTimeout(resolve, 4000));
                afficherStatutPrise('‚úÖ Test complet r√©ussi', 'success');
            } catch (error) {
                afficherStatutPrise('‚ùå Test complet √©chou√©', 'error');
            } finally {
                priseEnCours = false;
            }
        }

        // REMPLACER COMPL√àTEMENT la fonction scannerReseauLocal()
        async function scannerReseauLocal() {
            afficherStatutPrise('üîç Scan r√©seau en cours...', 'info');
            
            // R√©cup√©rer l'IP saisie par l'utilisateur
            const serverIp = document.getElementById('serverIp').value.trim();
            
            if (serverIp !== 'auto') {
                // Test direct de l'IP saisie
                console.log('üîç Test IP saisie:', serverIp);
                const success = await testerServeurTapo(serverIp);
                
                if (success) {
                    serverTapoUrl = `http://${serverIp}:3000`;
                    ipsDetectees = [serverIp];
                    afficherStatutPrise(`‚úÖ Serveur trouv√© : ${serverIp}`, 'success');
                } else {
                    afficherStatutPrise(`‚ùå Serveur non trouv√© sur ${serverIp}`, 'error');
                }
                return;
            }
            
            // Si "auto", scanner les IPs locales communes
            const ipsATester = [
                '192.168.1.100', '192.168.1.101', '192.168.1.102',
                '192.168.0.100', '192.168.0.101', '192.168.0.102',
                '10.0.0.100', '10.0.0.101'
            ];
            
            console.log('üîç Test IPs locales:', ipsATester);
            
            const promisesTest = ipsATester.map(ip => testerServeurTapo(ip));
            const resultats = await Promise.allSettled(promisesTest);
            
            ipsDetectees = [];
            for (let i = 0; i < resultats.length; i++) {
                if (resultats[i].status === 'fulfilled' && resultats[i].value) {
                    ipsDetectees.push(ipsATester[i]);
                }
            }
            
            if (ipsDetectees.length > 0) {
                serverTapoUrl = `http://${ipsDetectees[0]}:3000`;
                document.getElementById('serverIp').value = ipsDetectees[0];
                afficherStatutPrise(`‚úÖ Serveur trouv√© : ${ipsDetectees[0]}`, 'success');
            } else {
                afficherStatutPrise('‚ùå Aucun serveur Tapo trouv√©', 'error');
            }
        }

        function obtenirIpLocale() {
            return new Promise((resolve) => {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        const candidate = event.candidate.candidate;
                        const match = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                        if (match && !match[1].startsWith('127.')) {
                            pc.close();
                            resolve(match[1]);
                        }
                    }
                };
                
                setTimeout(() => {
                    pc.close();
                    resolve(null);
                }, 3000);
            });
        }

        async function testerServeurTapo(ip) {
            try {
                const response = await fetch(`http://${ip}:3000/ping`, {
                    method: 'GET',
                    timeout: 2000
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        function updateServerUrl() {
            const serverIp = document.getElementById('serverIp').value.trim();
            
            if (serverIp === 'auto') {
                if (ipsDetectees.length > 0) {
                    serverTapoUrl = `http://${ipsDetectees[0]}:3000`;
                } else {
                    scannerReseauLocal();
                    return;
                }
            } else if (serverIp) {
                serverTapoUrl = `http://${serverIp}:3000`;
            }
        }

        function afficherStatutPrise(message, type = 'info') {
            const statusDiv = document.getElementById('tapoStatus');
            const statusClasses = {
                'success': 'status-connected',
                'error': 'status-error',
                'info': 'status-connecting'
            };
            
            statusDiv.innerHTML = `<span class="status-indicator ${statusClasses[type]}">${message}</span>`;
        }

        async function controlerPrise(action, duree = null) {
            updateServerUrl();
            
            if (!serverTapoUrl) {
                afficherStatutPrise('‚ùå IP serveur non configur√©e', 'error');
                return false;
            }
            
            try {
                afficherStatutPrise(`üîÑ ${action}...`, 'info');
                
                // FORCER HTTPS pour compatibilit√© avec site Netlify HTTPS
                const httpsUrl = serverTapoUrl.replace('http:', 'https:');
                
                const response = await fetch(`${httpsUrl}/alerte/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source: 'surveillance_maritime',
                        timestamp: new Date().toISOString(),
                        duree: duree
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    afficherStatutPrise(`‚úÖ ${result.message}`, 'success');
                    
                    if (duree && action === 'on') {
                        setTimeout(async () => {
                            await controlerPrise('off');
                        }, duree * 1000);
                    }
                    
                    return true;
                } else {
                    throw new Error(`Erreur serveur: ${response.status}`);
                }
                
            } catch (error) {
                afficherStatutPrise(`‚ùå ${error.message}`, 'error');
                return false;
            }
        }


        async function allumerPrise() { await controlerPrise('on'); }
        async function eteindrePrise() { await controlerPrise('off'); }
        async function testPrise1sec() {
            if (priseEnCours) return;
            priseEnCours = true;
            await controlerPrise('on', 1);
            setTimeout(() => { priseEnCours = false; }, 2000);
        }

        /**
         * MODIFI√â : Alarme avec sir√®ne de 2s
         */
        async function declencherAlarmePhysique(navire, distance) {
            const autoTrigger = document.getElementById('autoTrigger').checked;
            if (!autoTrigger || priseEnCours) return;
            
            console.log('üö® D√âCLENCHEMENT ALARME PHYSIQUE !');
            
            // NOUVEAU : Sir√®ne de 2 secondes
            jouerSireneAlarme();
            
            const duree = parseInt(document.getElementById('alertDuration').value) || 10;
            
            priseEnCours = true;
            const success = await controlerPrise('on', duree);
            
            if (success) {
                afficherNotificationAlarme(`üö® ALARME ! Navire "${navire.shipName || 'Inconnu'}" √† ${Math.round(distance)}m`);
            }
            
            setTimeout(() => { priseEnCours = false; }, (duree + 2) * 1000);
        }

        function afficherNotificationAlarme(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                background: linear-gradient(45deg, #ff0000, #cc0000);
                color: white; padding: 15px 20px; border-radius: 10px;
                font-weight: bold; font-size: 16px; z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.5s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 10000);
        }

        // ========================================
        // FONCTIONS DE SURVEILLANCE (INCHANG√âES SAUF D√âLAIS)
        // ========================================
        
        function dessinerZonesSurveillance() {
            const lat = parseFloat(document.getElementById('latitudeCenter').value);
            const lon = parseFloat(document.getElementById('longitudeCenter').value);
            const rayon = parseFloat(document.getElementById('rayonSurveillance').value);
            
            // Supprimer les cercles existants
            cerclesZones.forEach(cercle => map.removeLayer(cercle));
            cerclesZones = [];
            
            // Zone d'approche (3km) - Vert
            const zoneApproche = L.circle([lat, lon], {
                color: '#28a745',
                fillColor: '#28a745',
                fillOpacity: 0.1,
                radius: Math.min(3000, rayon * 1000)
            }).addTo(map);
            cerclesZones.push(zoneApproche);
            
            // Zone vigilance (2km) - Orange
            const zoneVigilance = L.circle([lat, lon], {
                color: '#fd7e14',
                fillColor: '#fd7e14',
                fillOpacity: 0.15,
                radius: Math.min(2000, rayon * 1000)
            }).addTo(map);
            cerclesZones.push(zoneVigilance);
            
            // Zone alerte (1km) - Rouge
            const zoneAlerte = L.circle([lat, lon], {
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.2,
                radius: Math.min(1000, rayon * 1000)
            }).addTo(map);
            cerclesZones.push(zoneAlerte);
        }

        function calculerDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Rayon de la Terre en m√®tres
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function analyserNavire(navire) {
            const latCenter = parseFloat(document.getElementById('latitudeCenter').value);
            const lonCenter = parseFloat(document.getElementById('longitudeCenter').value);
            
            const distance = calculerDistance(
                latCenter, lonCenter,
                navire.latitude, navire.longitude
            );
            
            let zone = 'normale';
            let couleur = '#28a745';
            
            if (distance < 1000) {
                zone = 'alerte';
                couleur = '#dc3545';
                // MODIFI√â : D√©clencher l'alarme avec sir√®ne
                declencherAlarmePhysique(navire, distance);
            } else if (distance < 2000) {
                zone = 'vigilance';
                couleur = '#fd7e14';
            } else if (distance < 3000) {
                zone = 'approche';
                couleur = '#28a745';
            }
            
            return { distance, zone, couleur };
        }

        async function chargerNavires() {
            const token = document.getElementById('tokenEuris').value.trim();
            if (!token) {
                document.getElementById('statusIndicator').innerHTML = 
                    '<span class="status-indicator status-error">‚ùå Token EuRIS requis</span>';
                return;
            }
            
            try {
                const lat = parseFloat(document.getElementById('latitudeCenter').value);
                const lon = parseFloat(document.getElementById('longitudeCenter').value);
                const rayon = parseFloat(document.getElementById('rayonSurveillance').value);
                
                const marge = rayon / 111; // Approximation : 1 degr√© ‚âà 111 km
                
                const params = new URLSearchParams({
                    minLat: (lat - marge).toFixed(6),
                    maxLat: (lat + marge).toFixed(6),
                    minLon: (lon - marge).toFixed(6),
                    maxLon: (lon + marge).toFixed(6),
                    pageSize: 100
                });
                
                const response = await fetch(`/.netlify/functions/euris-proxy?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }
                
                const data = await response.json();
                afficherNavires(data.tracks || []);
                
            } catch (error) {
                console.error('Erreur chargement navires:', error);
                document.getElementById('statusIndicator').innerHTML = 
                    `<span class="status-indicator status-error">‚ùå ${error.message}</span>`;
            }
        }

        function afficherNavires(navires) {
            // Supprimer les marqueurs existants
            markersNavires.forEach(marker => map.removeLayer(marker));
            markersNavires = [];
            
            // Statistiques
            let stats = { total: 0, approche: 0, vigilance: 0, alerte: 0 };
            let naviresVigilanceList = [];
            let naviresAlerteList = [];
            
            const listeNavires = document.getElementById('listeNavires');
            listeNavires.innerHTML = '';
            
            navires.forEach(navire => {
                if (!navire.latitude || !navire.longitude) return;
                
                const analyse = analyserNavire(navire);
                stats.total++;
                
                // Compter par zone
                if (analyse.zone === 'alerte') {
                    stats.alerte++;
                    naviresAlerteList.push(navire);
                } else if (analyse.zone === 'vigilance') {
                    stats.vigilance++;
                    naviresVigilanceList.push(navire);
                } else if (analyse.zone === 'approche') {
                    stats.approche++;
                }
                
                // Marqueur sur la carte
                const marker = L.marker([navire.latitude, navire.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <strong>${navire.shipName || 'Navire inconnu'}</strong><br>
                        MMSI: ${navire.mmsi}<br>
                        Distance: ${Math.round(analyse.distance)}m<br>
                        Zone: ${analyse.zone}
                    `);
                markersNavires.push(marker);
                
                // √âl√©ment dans la liste
                const navireElement = document.createElement('div');
                navireElement.className = `navire-item navire-${analyse.zone}`;
                navireElement.innerHTML = `
                    <div class="navire-header">
                        <span class="navire-nom">${navire.shipName || 'Navire inconnu'}</span>
                        <span class="navire-distance distance-${analyse.zone}">
                            ${Math.round(analyse.distance)}m
                        </span>
                    </div>
                    <div class="navire-details">
                        <div class="navire-detail">
                            <span>MMSI:</span>
                            <strong>${navire.mmsi}</strong>
                        </div>
                        <div class="navire-detail">
                            <span>Type:</span>
                            <strong>${navire.shipType || 'Inconnu'}</strong>
                        </div>
                        <div class="navire-detail">
                            <span>Vitesse:</span>
                            <strong>${navire.speed || 0} n≈ìuds</strong>
                        </div>
                        <div class="navire-detail">
                            <span>Cap:</span>
                            <strong>${navire.course || 0}¬∞</strong>
                        </div>
                    </div>
                `;
                
                navireElement.addEventListener('click', () => {
                    map.setView([navire.latitude, navire.longitude], 15);
                    marker.openPopup();
                });
                
                listeNavires.appendChild(navireElement);
            });
            
            // Mettre √† jour les statistiques
            document.getElementById('totalNavires').textContent = stats.total;
            document.getElementById('naviresApproche').textContent = stats.approche;
            document.getElementById('naviresVigilanceCount').textContent = stats.vigilance;
            document.getElementById('naviresAlerte').textContent = stats.alerte;
            document.getElementById('derniereMaj').textContent = new Date().toLocaleTimeString();
            
            // Gestion des alertes visuelles
            gererAlertes(naviresAlerteList, naviresVigilanceList);
            
            document.getElementById('statusIndicator').innerHTML = 
                '<span class="status-indicator status-connected">‚úÖ Surveillance active</span>';
        }

        function gererAlertes(naviresAlerte, naviresVigilance) {
            const banniereAlerte = document.getElementById('banniereAlerte');
            const panneauAttention = document.getElementById('panneauAttention');
            
            // Banni√®re rouge pour navires < 1km
            if (naviresAlerte.length > 0) {
                banniereAlerte.style.display = 'block';
                banniereAlerte.textContent = 
                    `üö® ALERTE ROUGE : ${naviresAlerte.length} navire(s) d√©tect√©(s) √† moins de 1km ! üö®`;
            } else {
                banniereAlerte.style.display = 'none';
            }
            
            // Panneau orange pour navires < 2km
            if (naviresVigilance.length > 0) {
                panneauAttention.style.display = 'block';
                const listeVigilance = document.getElementById('naviresVigilance');
                listeVigilance.innerHTML = naviresVigilance.map(navire => `
                    <div class="navire-panneau">
                        <strong>${navire.shipName || 'Inconnu'}</strong><br>
                        MMSI: ${navire.mmsi}
                    </div>
                `).join('');
            } else {
                panneauAttention.style.display = 'none';
            }
        }

        function toggleSurveillance() {
            const btn = document.getElementById('btnSurveillance');
            
            if (!surveillanceActive) {
                // D√©marrer la surveillance
                surveillanceActive = true;
                btn.textContent = 'Arr√™ter la surveillance';
                btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                
                // Scanner le r√©seau au d√©marrage si IP en auto
                if (document.getElementById('serverIp').value === 'auto') {
                    scannerReseauLocal();
                }
                
                chargerNavires();
                // MODIFI√â : 30000 -> 15000 (15 secondes)
                intervalSurveillance = setInterval(chargerNavires, 15000);
                
                // MODIFI√â : Compteur de 15 secondes
                compteurRefresh = 15;
                intervalCompteur = setInterval(() => {
                    compteurRefresh--;
                    document.getElementById('compteurRefresh').textContent = 
                        `Prochaine MAJ : ${compteurRefresh}s`;
                    if (compteurRefresh <= 0) {
                        compteurRefresh = 15;
                    }
                }, 1000);
                
            } else {
                // Arr√™ter la surveillance
                surveillanceActive = false;
                btn.textContent = 'D√©marrer la surveillance';
                btn.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                
                clearInterval(intervalSurveillance);
                clearInterval(intervalCompteur);
                
                document.getElementById('statusIndicator').innerHTML = 
                    '<span class="status-indicator status-connecting">üîÑ Surveillance arr√™t√©e</span>';
            }
        }

        // ========================================
        // INITIALISATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            initCarte();
            
            // Auto-scan au chargement
            setTimeout(() => {
                if (document.getElementById('serverIp').value === 'auto') {
                    scannerReseauLocal();
                }
            }, 1000);
            
            // Mise √† jour des zones quand les coordonn√©es changent
            document.getElementById('latitudeCenter').addEventListener('change', dessinerZonesSurveillance);
            document.getElementById('longitudeCenter').addEventListener('change', dessinerZonesSurveillance);
            document.getElementById('rayonSurveillance').addEventListener('change', dessinerZonesSurveillance);
        });
    </script>
</body>
</html>
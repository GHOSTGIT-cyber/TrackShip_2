<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alerte Navire 1km – Tapo</title>
  <style>
    body { font-family: system-ui, Segoe UI, Arial, sans-serif; margin: 0; padding: 16px; background: #f6f7fb; color: #20223a; }
    .box { background: #fff; border: 1px solid #e8ebf6; border-radius: 10px; padding: 14px; margin-bottom: 14px; }
    h1 { font-size: 20px; margin: 4px 0 12px; }
    label { display: block; font-size: 13px; margin: 8px 0 4px; }
    input { width: 100%; padding: 10px; border: 1px solid #cfd5e6; border-radius: 8px; font-size: 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 180px; }
    button { cursor: pointer; padding: 10px 14px; border: 0; border-radius: 8px; background: #5569ff; color: #fff; font-weight: 600; }
    button.secondary { background: #e8eaff; color: #29306d; }
    .status { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; white-space: pre-wrap; background: #f2f4fb; color: #1d1f3f; border-radius: 8px; padding: 10px; overflow: auto; max-height: 180px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #eef2ff; color: #272968; font-size: 12px; margin-left: 6px; }
    .alert { background: #ffe9ea; color: #9a0414; border-color: #ffc7cc; }
    .ok { background: #e9fff1; color: #0b6b34; border-color: #b8f0cb; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Alerte 1 km <span class="pill">alerte.bakabi.fr</span></h1>
    <div class="row">
      <div>
        <label>Token EuRIS (Bearer)</label>
        <input id="eurisToken" type="text" placeholder="Collez le token ici" />
      </div>
      <div>
        <label>Rayon alerte (m)</label>
        <input id="rayon" type="number" value="1000" />
      </div>
      <div>
        <label>Période scan (s)</label>
        <input id="periode" type="number" value="20" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Latitude base</label>
        <input id="latBase" type="number" step="0.000001" value="48.853229" />
      </div>
      <div>
        <label>Longitude base</label>
        <input id="lonBase" type="number" step="0.000001" value="2.225328" />
      </div>
      <div>
        <label>Page size API</label>
        <input id="pageSize" type="number" value="100" />
      </div>
    </div>
  </div>

  <div class="box">
    <h1>Prise Tapo (Cloud)</h1>
    <div class="row" style="margin-top:10px">
      <button id="btnTest">Tester la prise (allumer 10s)</button>
      <button id="btnOn">Allumer</button>
      <button id="btnOff" class="secondary">Éteindre</button>
    </div>
  </div>

  <div class="box" id="boxEtat">
    <h1>État</h1>
    <div class="row">
      <div><div id="etatAlerte" class="pill">Alerte: inactif</div></div>
      <div><div id="naviresCompteur" class="pill">Navires proches: 0</div></div>
      <div><div id="derniereMaj" class="pill">Dernière MAJ: jamais</div></div>
    </div>
    <div class="status" id="log"></div>
  </div>

  <div class="box">
    <div class="row">
      <button id="btnStart">Démarrer la surveillance</button>
      <button id="btnStop" class="secondary">Arrêter</button>
    </div>
  </div>

  <script>
    // ================= UTILITAIRES =================
    const logEl = document.getElementById('log');
    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    // Distance Haversine (m)
    function distanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    // BBox en degrés autour du point (approximation)
    function makeBBox(lat, lon, rayonM) {
      const dLat = (rayonM / 111320);
      const dLon = (rayonM / (111320 * Math.cos(lat * Math.PI/180)));
      return {
        minLat: lat - dLat, maxLat: lat + dLat,
        minLon: lon - dLon, maxLon: lon + dLon
      };
    }

    // ================= RÉFÉRENCES UI =================
    const el = {
      token: document.getElementById('eurisToken'),
      rayon: document.getElementById('rayon'),
      periode: document.getElementById('periode'),
      lat: document.getElementById('latBase'),
      lon: document.getElementById('lonBase'),
      pageSize: document.getElementById('pageSize'),
      btnTest: document.getElementById('btnTest'),
      btnOn: document.getElementById('btnOn'),
      btnOff: document.getElementById('btnOff'),
      btnStart: document.getElementById('btnStart'),
      btnStop: document.getElementById('btnStop'),
      etatAlerte: document.getElementById('etatAlerte'),
      naviresCompteur: document.getElementById('naviresCompteur'),
      derniereMaj: document.getElementById('derniereMaj'),
      boxEtat: document.getElementById('boxEtat'),
    };

    let timer = null;
    let alerteActive = false;

    // ================= BACKEND TAPO (Hostinger) =================
    // Envoie uniquement action/durée au serveur /api/tapo.php, sans exposer d’identifiants Tapo.
    async function tapoApi(action, dureeSec) {
      const payload = dureeSec ? { action, duree: Number(dureeSec) } : { action };
      try {
        const res = await fetch('/api/tapo.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || data.ok === false) throw new Error(data.error || 'Erreur');
        log(data.message || ((action === 'on') ? 'Prise allumée' : 'Prise éteinte'));
      } catch (e) {
        log('Erreur Tapo: ' + e.message);
      }
    }

    // ================= APPEL EURIS VIA PROXY PHP =================
    async function fetchNavires() {
      const token = el.token.value.trim();
      if (!token) {
        log('⚠️ Token EuRIS requis');
        return { tracks: [] };
      }
      const lat = Number(el.lat.value);
      const lon = Number(el.lon.value);
      const rayon = Number(el.rayon.value);
      const pageSize = Number(el.pageSize.value);

      const bbox = makeBBox(lat, lon, Math.max(2000, rayon)); // BBox > rayon pour être sûr de capturer
      const url = `./euris-proxy.php?minLat=${bbox.minLat.toFixed(6)}&maxLat=${bbox.maxLat.toFixed(6)}&minLon=${bbox.minLon.toFixed(6)}&maxLon=${bbox.maxLon.toFixed(6)}&pageSize=${pageSize}`;

      try {
        const res = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
        const data = await res.json();
        if (!res.ok) {
          log(`Erreur API: ${res.status} ${data?.message || data?.error || 'inconnu'}`);
          return { tracks: [] };
        }
        return data;
      } catch (e) {
        log('Erreur réseau API: ' + e.message);
        return { tracks: [] };
      }
    }

    // ================= BOUCLE DE SURVEILLANCE =================
    async function tick() {
      const lat = Number(el.lat.value);
      const lon = Number(el.lon.value);
      const rayon = Number(el.rayon.value);

      const { tracks = [] } = await fetchNavires();

      // Filtrer par distance exacte au centre
      const proches = [];
      for (const t of tracks) {
        const nlat = Number(t.latitude ?? t.lat ?? t.Latitude ?? 0);
        const nlon = Number(t.longitude ?? t.lon ?? t.Longitude ?? 0);
        if (!isFinite(nlat) || !isFinite(nlon)) continue;
        const d = distanceMeters(lat, lon, nlat, nlon);
        if (d <= rayon) proches.push({ ...t, distance: Math.round(d) });
      }

      el.naviresCompteur.textContent = `Navires proches: ${proches.length}`;
      el.derniereMaj.textContent = 'Dernière MAJ: ' + new Date().toLocaleTimeString();

      const enAlerte = proches.length > 0;
      if (enAlerte && !alerteActive) {
        alerteActive = true;
        el.etatAlerte.textContent = 'Alerte: ACTIVE';
        el.etatAlerte.className = 'pill';
        el.boxEtat.className = 'box alert';
        log(`ALERTE: ${proches.length} navire(s) <= ${rayon} m → allumer`);
        tapoApi('on');
      } else if (!enAlerte && alerteActive) {
        alerteActive = false;
        el.etatAlerte.textContent = 'Alerte: inactif';
        el.etatAlerte.className = 'pill';
        el.boxEtat.className = 'box ok';
        log('FIN ALERTE → éteindre');
        tapoApi('off');
      }
    }

    // ================= CONTRÔLES UI =================
    el.btnStart.addEventListener('click', () => {
      if (timer) return;
      log('Surveillance démarrée');
      el.boxEtat.className = 'box ok';
      tick();
      timer = setInterval(tick, Math.max(5, Number(el.periode.value)) * 1000);
    });

    el.btnStop.addEventListener('click', () => {
      if (timer) {
        clearInterval(timer);
        timer = null;
        log('Surveillance arrêtée');
      }
    });

    el.btnTest.addEventListener('click', () => tapoApi('on', 10));
    el.btnOn.addEventListener('click', () => tapoApi('on'));
    el.btnOff.addEventListener('click', () => tapoApi('off'));
  </script>
</body>
</html>

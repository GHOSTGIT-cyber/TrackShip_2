<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveillance des Navires - Seine</title>
    
    <!-- CORRECTION CSP POUR TAPO -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:; script-src 'self' 'unsafe-inline' unpkg.com cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' unpkg.com; img-src 'self' data: *.openstreetmap.org *.tile.openstreetmap.org; connect-src 'self' *.eurisportal.eu http: https: ws: wss:; font-src 'self' data:;">
    
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- Bannière d'alerte rouge (masquée par défaut) -->
    <div id="banniereAlerte" class="banniere-alerte" style="display: none;">
        🚨 ALERTE ROUGE : Navire détecté à moins de 1km ! 🚨
    </div>

    <!-- Panneau d'attention orange (masqué par défaut) -->
    <div id="panneauAttention" class="panneau-attention" style="display: none;">
        <div style="font-size: 20px; margin-bottom: 15px;">⚠️ VIGILANCE</div>
        <div>Navires en zone de surveillance (2km) :</div>
        <div id="naviresVigilance"></div>
    </div>

    <!-- Compteur de rafraîchissement -->
    <div id="compteurRefresh" class="compteur-refresh">
        Prochaine MAJ : 30s
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🚢 Surveillance des Navires - Seine</h1>
            <p>API EuRIS : surveillance automatique avec alertes de proximité</p>
        </div>

        <!-- Contrôles -->
        <div class="controls">
            <div class="form-group">
                <div>
                    <label for="tokenEuris">Token EuRIS :</label>
                    <input type="text" id="tokenEuris" placeholder="Votre token d'accès EuRIS">
                </div>
                <div>
                    <label for="filtreNavire">Filtre navire :</label>
                    <select id="filtreNavire">
                        <option value="tous">Tous les navires</option>
                        <option value="mouvement">En mouvement uniquement</option>
                        <option value="arrete">À l'arrêt uniquement</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div>
                    <label for="latitudeCenter">Latitude centre :</label>
                    <input type="number" id="latitudeCenter" value="48.853229" step="0.0001">
                </div>
                <div>
                    <label for="longitudeCenter">Longitude centre :</label>
                    <input type="number" id="longitudeCenter" value="2.225328" step="0.0001">
                </div>
                <div>
                    <label for="rayonSurveillance">Rayon surveillance (km) :</label>
                    <input type="number" id="rayonSurveillance" value="5" min="1" max="50">
                </div>
            </div>

            <button id="btnSurveillance" class="btn" onclick="toggleSurveillance()">
                Démarrer la surveillance
            </button>
            
            <div id="statusIndicator" class="status-indicator status-connecting">
                🔄 Prêt à démarrer
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="content">
            <!-- Carte -->
            <div class="map-container">
                <div id="map"></div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Statistiques -->
                <div class="stats">
                    <h3>📊 Statistiques</h3>
                    <div class="stat-item">
                        <span class="stat-label">Navires détectés</span>
                        <span class="stat-value" id="totalNavires">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">🟢 Zone d'approche (3km)</span>
                        <span class="stat-value" id="naviresApproche">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">🟠 Zone vigilance (2km)</span>
                        <span class="stat-value" id="naviresVigilanceCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">🔴 Zone alerte (1km)</span>
                        <span class="stat-value" id="naviresAlerte">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Dernière MAJ</span>
                        <span class="stat-value" id="derniereMaj">Jamais</span>
                    </div>
                </div>

                <!-- Liste des navires -->
                <div class="navires-list">
                    <h3>🚢 Navires surveillés</h3>
                    <div id="listeNavires" class="loading">
                        Cliquez sur "Démarrer la surveillance" pour commencer...
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTRÔLE TAPO P110 APRÈS LA CARTE - VISIBLE -->
        <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #007bff;">
            <h3 style="margin: 0 0 15px 0; color: #495057; font-size: 1.3em;">🔌 Contrôle Prise Tapo P110</h3>
            
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                <label style="font-weight: 600; color: #495057;">IP Serveur :</label>
                <input type="text" id="serverIp" value="auto" placeholder="auto ou 192.168.1.100" style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="scannerReseauLocal()" style="background: #6f42c1; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600;">🔍 Scanner</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                <button onclick="allumerPrise()" style="background: #28a745; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600;">🟢 Allumer</button>
                <button onclick="eteindrePrise()" style="background: #dc3545; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600;">🔴 Éteindre</button>
                <button onclick="testPrise5sec()" style="background: #fd7e14; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600;">🧪 Test 5s</button>
                <button onclick="testPrise1sec()" style="background: #007bff; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600;">⚡ Flash 1s</button>
                <button onclick="clignoterPrise()" style="background: #6f42c1; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600;">💡 Clignoter</button>
            </div>
            
            <div id="tapoStatus" style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 14px;">🔄 Recherche serveur...</div>
            
            <div style="display: flex; gap: 20px; align-items: center; margin-top: 15px;">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="autoTrigger" checked> 
                    Auto-déclenchement (navire < 1km)
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                    Durée d'alerte : <input type="number" id="alertDuration" value="30" min="5" max="300" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; margin-left: 5px;"> sec
                </label>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let map;
        let surveillanceActive = false;
        let intervalSurveillance;
        let intervalCompteur;
        let compteurRefresh = 30;
        let markersNavires = [];
        let cerclesZones = [];
        
        // Variables Tapo
        let serverTapoUrl = null;
        let priseEnCours = false;
        let ipsDetectees = [];

        // Initialisation de la carte
        function initCarte() {
            const lat = parseFloat(document.getElementById('latitudeCenter').value);
            const lon = parseFloat(document.getElementById('longitudeCenter').value);
            
            map = L.map('map').setView([lat, lon], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Marqueur de position de surveillance
            L.marker([lat, lon]).addTo(map)
                .bindPopup('📍 Position de surveillance')
                .openPopup();
            
            dessinerZonesSurveillance();
        }

        // FONCTIONS TAPO - NOUVELLES
        async function scannerReseauLocal() {
            document.getElementById('tapoStatus').textContent = '🔍 Scan réseau en cours...';
            const ipLocale = await obtenirIpLocale();
            if (!ipLocale) {
                document.getElementById('tapoStatus').textContent = '❌ IP locale non détectée';
                return;
            }
            const sousReseau = ipLocale.substring(0, ipLocale.lastIndexOf('.'));
            const ipsATester = [1, 2, 10, 100, 101, 102, 103, 104, 105, 110, 150, 200].map(ip => `${sousReseau}.${ip}`);
            const promisesTest = ipsATester.map(ip => testerServeurTapo(ip));
            const resultats = await Promise.allSettled(promisesTest);
            ipsDetectees = [];
            for (let i = 0; i < resultats.length; i++) {
                if (resultats[i].status === 'fulfilled' && resultats[i].value) {
                    ipsDetectees.push(ipsATester[i]);
                }
            }
            if (ipsDetectees.length > 0) {
                serverTapoUrl = `http://${ipsDetectees[0]}:3000`;
                document.getElementById('serverIp').value = ipsDetectees[0];
                document.getElementById('tapoStatus').textContent = `✅ Serveur trouvé : ${ipsDetectees[0]}`;
            } else {
                document.getElementById('tapoStatus').textContent = '❌ Aucun serveur Tapo trouvé sur le réseau';
            }
        }

        function obtenirIpLocale() {
            return new Promise((resolve) => {
                const pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]});
                pc.createDataChannel('');
                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        const match = event.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                        if (match && !match[1].startsWith('127.')) {
                            pc.close();
                            resolve(match[1]);
                        }
                    }
                };
                setTimeout(() => { pc.close(); resolve(null); }, 3000);
            });
        }

        async function testerServeurTapo(ip) {
            try {
                await fetch(`http://${ip}:3000/ping`, {method: 'GET', mode: 'no-cors', timeout: 2000});
                return true;
            } catch (error) {
                return false;
            }
        }

        function updateServerUrl() {
            const serverIp = document.getElementById('serverIp').value.trim();
            if (serverIp === 'auto') {
                if (ipsDetectees.length > 0) {
                    serverTapoUrl = `http://${ipsDetectees[0]}:3000`;
                } else {
                    scannerReseauLocal();
                    return;
                }
            } else if (serverIp) {
                serverTapoUrl = `http://${serverIp}:3000`;
            }
        }

        async function controlerPrise(action, duree = null) {
            updateServerUrl();
            if (!serverTapoUrl) {
                document.getElementById('tapoStatus').textContent = '❌ IP serveur non configurée';
                return false;
            }
            try {
                document.getElementById('tapoStatus').textContent = `🔄 ${action}...`;
                await fetch(`${serverTapoUrl}/alerte/${action}`, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({source: 'surveillance_maritime', timestamp: new Date().toISOString(), duree: duree})
                });
                document.getElementById('tapoStatus').textContent = `✅ Prise ${action} avec succès`;
                if (duree && action === 'on') {
                    setTimeout(async () => { await controlerPrise('off'); }, duree * 1000);
                }
                return true;
            } catch (error) {
                document.getElementById('tapoStatus').textContent = '❌ Erreur contrôle prise';
                return false;
            }
        }

        async function allumerPrise() { await controlerPrise('on'); }
        async function eteindrePrise() { await controlerPrise('off'); }
        async function testPrise5sec() {
            if (priseEnCours) return;
            priseEnCours = true;
            await controlerPrise('on', 5);
            setTimeout(() => { priseEnCours = false; }, 6000);
        }
        async function testPrise1sec() {
            if (priseEnCours) return;
            priseEnCours = true;
            await controlerPrise('on', 1);
            setTimeout(() => { priseEnCours = false; }, 2000);
        }
        async function clignoterPrise() {
            if (priseEnCours) return;
            priseEnCours = true;
            document.getElementById('tapoStatus').textContent = '💡 Clignotement en cours...';
            for (let i = 0; i < 5; i++) {
                await controlerPrise('on');
                await new Promise(resolve => setTimeout(resolve, 500));
                await controlerPrise('off');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            document.getElementById('tapoStatus').textContent = '💡 Clignotement terminé';
            priseEnCours = false;
        }

        async function declencherAlarmePhysique(navire, distance) {
            const autoTrigger = document.getElementById('autoTrigger').checked;
            if (!autoTrigger || priseEnCours) return;
            console.log('🚨 DÉCLENCHEMENT ALARME PHYSIQUE !');
            const duree = parseInt(document.getElementById('alertDuration').value) || 30;
            priseEnCours = true;
            await controlerPrise('on', duree);
            setTimeout(() => { priseEnCours = false; }, (duree + 2) * 1000);
        }

        // VOTRE CODE EXISTANT INCHANGÉ
        function dessinerZonesSurveillance() {
            const lat = parseFloat(document.getElementById('latitudeCenter').value);
            const lon = parseFloat(document.getElementById('longitudeCenter').value);
            const rayon = parseFloat(document.getElementById('rayonSurveillance').value);
            
            cerclesZones.forEach(cercle => map.removeLayer(cercle));
            cerclesZones = [];
            
            const zoneApproche = L.circle([lat, lon], {
                color: '#28a745',
                fillColor: '#28a745',
                fillOpacity: 0.1,
                radius: Math.min(3000, rayon * 1000)
            }).addTo(map);
            cerclesZones.push(zoneApproche);
            
            const zoneVigilance = L.circle([lat, lon], {
                color: '#fd7e14',
                fillColor: '#fd7e14',
                fillOpacity: 0.15,
                radius: Math.min(2000, rayon * 1000)
            }).addTo(map);
            cerclesZones.push(zoneVigilance);
            
            const zoneAlerte = L.circle([lat, lon], {
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.2,
                radius: Math.min(1000, rayon * 1000)
            }).addTo(map);
            cerclesZones.push(zoneAlerte);
        }

        function calculerDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function analyserNavire(navire) {
            const latCenter = parseFloat(document.getElementById('latitudeCenter').value);
            const lonCenter = parseFloat(document.getElementById('longitudeCenter').value);
            
            const distance = calculerDistance(
                latCenter, lonCenter,
                navire.latitude, navire.longitude
            );
            
            let zone = 'normale';
            let couleur = '#28a745';
            
            if (distance < 1000) {
                zone = 'alerte';
                couleur = '#dc3545';
                declencherAlarmePhysique(navire, distance);
            } else if (distance < 2000) {
                zone = 'vigilance';
                couleur = '#fd7e14';
            } else if (distance < 3000) {
                zone = 'approche';
                couleur = '#28a745';
            }
            
            return { distance, zone, couleur };
        }

        async function chargerNavires() {
            const token = document.getElementById('tokenEuris').value.trim();
            if (!token) {
                document.getElementById('statusIndicator').innerHTML = 
                    '<span class="status-indicator status-error">❌ Token EuRIS requis</span>';
                return;
            }
            
            try {
                const lat = parseFloat(document.getElementById('latitudeCenter').value);
                const lon = parseFloat(document.getElementById('longitudeCenter').value);
                const rayon = parseFloat(document.getElementById('rayonSurveillance').value);
                
                const marge = rayon / 111;
                
                const params = new URLSearchParams({
                    minLat: (lat - marge).toFixed(6),
                    maxLat: (lat + marge).toFixed(6),
                    minLon: (lon - marge).toFixed(6),
                    maxLon: (lon + marge).toFixed(6),
                    pageSize: 100
                });
                
                const response = await fetch(`/.netlify/functions/euris-proxy?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status}`);
                }
                
                const data = await response.json();
                afficherNavires(data.tracks || []);
                
            } catch (error) {
                console.error('Erreur chargement navires:', error);
                document.getElementById('statusIndicator').innerHTML = 
                    `<span class="status-indicator status-error">❌ ${error.message}</span>`;
            }
        }

        function afficherNavires(navires) {
            markersNavires.forEach(marker => map.removeLayer(marker));
            markersNavires = [];
            
            let stats = { total: 0, approche: 0, vigilance: 0, alerte: 0 };
            let naviresVigilanceList = [];
            let naviresAlerteList = [];
            
            const listeNavires = document.getElementById('listeNavires');
            listeNavires.innerHTML = '';
            
            navires.forEach(navire => {
                if (!navire.latitude || !navire.longitude) return;
                
                const analyse = analyserNavire(navire);
                stats.total++;
                
                if (analyse.zone === 'alerte') {
                    stats.alerte++;
                    naviresAlerteList.push(navire);
                } else if (analyse.zone === 'vigilance') {
                    stats.vigilance++;
                    naviresVigilanceList.push(navire);
                } else if (analyse.zone === 'approche') {
                    stats.approche++;
                }
                
                const marker = L.marker([navire.latitude, navire.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <strong>🚢 ${navire.shipName || 'Navire inconnu'}</strong><br>
                        MMSI: ${navire.mmsi}<br>
                        Distance: ${Math.round(analyse.distance)}m<br>
                        Zone: ${analyse.zone}
                    `);
                markersNavires.push(marker);
                
                const navireElement = document.createElement('div');
                navireElement.className = `navire-item navire-${analyse.zone}`;
                navireElement.innerHTML = `
                    <div class="navire-header">
                        <span class="navire-nom">🚢 ${navire.shipName || 'Navire inconnu'}</span>
                        <span class="navire-distance distance-${analyse.zone}">
                            ${Math.round(analyse.distance)}m
                        </span>
                    </div>
                    <div class="navire-details">
                        <div class="navire-detail">
                            <span>MMSI:</span>
                            <strong>${navire.mmsi}</strong>
                        </div>
                        <div class="navire-detail">
                            <span>Type:</span>
                            <strong>${navire.shipType || 'Inconnu'}</strong>
                        </div>
                        <div class="navire-detail">
                            <span>Vitesse:</span>
                            <strong>${navire.speed || 0} nœuds</strong>
                        </div>
                        <div class="navire-detail">
                            <span>Cap:</span>
                            <strong>${navire.course || 0}°</strong>
                        </div>
                    </div>
                `;
                
                navireElement.addEventListener('click', () => {
                    map.setView([navire.latitude, navire.longitude], 15);
                    marker.openPopup();
                });
                
                listeNavires.appendChild(navireElement);
            });
            
            document.getElementById('totalNavires').textContent = stats.total;
            document.getElementById('naviresApproche').textContent = stats.approche;
            document.getElementById('naviresVigilanceCount').textContent = stats.vigilance;
            document.getElementById('naviresAlerte').textContent = stats.alerte;
            document.getElementById('derniereMaj').textContent = new Date().toLocaleTimeString();
            
            gererAlertes(naviresAlerteList, naviresVigilanceList);
            
            document.getElementById('statusIndicator').innerHTML = 
                '<span class="status-indicator status-connected">✅ Surveillance active</span>';
        }

        function gererAlertes(naviresAlerte, naviresVigilance) {
            const banniereAlerte = document.getElementById('banniereAlerte');
            const panneauAttention = document.getElementById('panneauAttention');
            
            if (naviresAlerte.length > 0) {
                banniereAlerte.style.display = 'block';
                banniereAlerte.textContent = 
                    `🚨 ALERTE ROUGE : ${naviresAlerte.length} navire(s) détecté(s) à moins de 1km ! 🚨`;
                console.log('🚨 Déclenchement alerte rouge pour navire en mouvement:', naviresAlerte[0].shipName);
            } else {
                banniereAlerte.style.display = 'none';
            }
            
            if (naviresVigilance.length > 0) {
                panneauAttention.style.display = 'block';
                const listeVigilance = document.getElementById('naviresVigilance');
                listeVigilance.innerHTML = naviresVigilance.map(navire => `
                    <div class="navire-panneau">
                        <strong>🚢 ${navire.shipName || 'Inconnu'}</strong><br>
                        MMSI: ${navire.mmsi}
                    </div>
                `).join('');
            } else {
                panneauAttention.style.display = 'none';
            }
        }

        function toggleSurveillance() {
            const btn = document.getElementById('btnSurveillance');
            
            if (!surveillanceActive) {
                surveillanceActive = true;
                btn.textContent = 'Arrêter la surveillance';
                btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                
                if (document.getElementById('serverIp').value === 'auto') {
                    scannerReseauLocal();
                }
                
                chargerNavires();
                intervalSurveillance = setInterval(chargerNavires, 30000);
                
                compteurRefresh = 30;
                intervalCompteur = setInterval(() => {
                    compteurRefresh--;
                    document.getElementById('compteurRefresh').textContent = 
                        `Prochaine MAJ : ${compteurRefresh}s`;
                    if (compteurRefresh <= 0) {
                        compteurRefresh = 30;
                    }
                }, 1000);
                
            } else {
                surveillanceActive = false;
                btn.textContent = 'Démarrer la surveillance';
                btn.style.background = 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)';
                
                clearInterval(intervalSurveillance);
                clearInterval(intervalCompteur);
                
                document.getElementById('statusIndicator').innerHTML = 
                    '<span class="status-indicator status-connecting">🔄 Surveillance arrêtée</span>';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initCarte();
            
            setTimeout(() => {
                if (document.getElementById('serverIp').value === 'auto') {
                    scannerReseauLocal();
                }
            }, 1000);
            
            document.getElementById('latitudeCenter').addEventListener('change', dessinerZonesSurveillance);
            document.getElementById('longitudeCenter').addEventListener('change', dessinerZonesSurveillance);
            document.getElementById('rayonSurveillance').addEventListener('change', dessinerZonesSurveillance);
        });
    </script>
</body>
</html>
